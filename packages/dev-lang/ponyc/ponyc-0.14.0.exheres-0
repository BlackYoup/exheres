# Copyright 2017 Arnaud Lefebvre <a.lefebvre@outlook.fr>
# Distributed under the terms of the GNU General Public License v2

require github [ user=ponylang ]

SUMMARY="The ponylang compiler"

DESCRIPTION="
Pony is an open-source, actor-model, capabilities-secure, high
performance programming language
"
HOMEPAGE="http://www.ponylang.org"

LICENCES="BSD-2"
SLOT="0"
PLATFORMS="~x86 ~amd64"

MYOPTIONS="
    providers: ( libressl openssl ) [[ number-selected = exactly-one ]]
"

DEPENDENCIES="
    build+run:
        dev-lang/clang[>=3.3]
        dev-lang/llvm[>=3.7.1]
        dev-libs/pcre2
        sys-libs/ncurses
        sys-libs/zlib
        providers:libressl? ( dev-libs/libressl:= )
        providers:openssl? ( dev-libs/openssl )
"

src_compile(){
    emake verbose=true && emake docs
}

src_install(){
    # The makefile installs things here and there without
    # using conventionnal paths

    local buildFolder=build/release/
    local dest="${IMAGE}"/usr/$(exhost --target)
    emake destdir="${dest}" install

    # ponyc and its standard library (packages folder) need to be at the same place
    edo mkdir -p "${dest}"/lib/${PN}/bin
    edo mv "${dest}"/bin/ponyc "${dest}"/lib/${PN}/bin/ponyc
    edo mv "${dest}"/packages/ "${dest}"/lib/${PN}
    dosym /usr/$(exhost --target)/lib/${PN}/bin/ponyc /usr/$(exhost --target)/bin/ponyc
    dodoc -r stdlib-docs
}
